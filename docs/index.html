<html>

<head>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css">
	<link rel="stylesheet" href="style.css">
	<script defer type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/8.4.0/markdown-it.js"></script>
	<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
	<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/javascript.min.js"></script>
	<script type="text/javascript">
		window.addEventListener("load", function () {
			function empty(element) {
				while (element.hasChildNodes()) element.removeChild(element.lastChild);
			}
			function ajax(url = "/", verb = "GET", data = null) {
				return new Promise(function (resolve, reject) {
					const req = new XMLHttpRequest();
					req.onreadystatechange = function () {
						if (req.readyState === 4) {
							if (req.status >= 200 && req.status < 400) {
								resolve(req.response);
							} else {
								reject(new Error("HTTP Error " + req.status + ": " + req.statusText));
							}
						}
					};
					req.open(verb, url);
					req.responseType = "text";
					req.setRequestHeader("X-Requested-With", "XMLHttpRequest");
					req.send(data);
				});
			}
			function loadPage(title) {
				showIndicator();
				hideError();
				const cached = cache.get(title);
				if (cached !== undefined) {
					empty(pageContainer);
					showIndicator(false);
					pageContainer.appendChild(cached.cloneNode(true));
				} else {
					ajax(title + ".md").then(function (markdown) {
						empty(pageContainer);
						showIndicator(false);
						const page = document.createRange().createContextualFragment(mdParser.render(markdown));
						page.querySelectorAll("code").forEach(element => hljs.highlightBlock(element));
						pageContainer.appendChild(page.cloneNode(true));
						cache.set(title, page);
					}).catch(showError);
				}
			}
			var showingError = false;
			function showError(error) {
				empty(errorContainer);
				errorContainer.insertAdjacentText("afterbegin", error.message);
				pageContainer.classList.add("hidden");
				showIndicator(false);
				errorContainer.classList.remove("hidden");
				showingError = true;
			}
			function hideError() {
				if (!showingError) return;
				errorContainer.classList.add("hidden");
				pageContainer.classList.remove("hidden");
				showingError = false;
			}
			var loading = true;
			function showIndicator(show = true) {
				if (show && loading || !show && !loading) return;
				const action = show ? "remove" : "add";
				dimmer.classList[action]("hidden");
				indicator.classList[action]("hidden");
				loading = show;
			}
			const dimmer = document.getElementById("dimmer");
			const indicator = document.getElementById("loadIndicator")
			const pageContainer = document.getElementById("pageContainer");
			const errorContainer = document.getElementById("errorContainer");
			const elementTemplate = document.createElement("div");
			const sidebarList = document.getElementById("sidebarList");
			const mdParser = markdownit();
			const cache = new Map();
			elementTemplate.setAttribute("class", "sidebarElement")
			document.getElementById("sidebarHeader").addEventListener("click", () => loadPage("home"));
			loadPage("home");
			ajax("index.json").then(function (body) {
				const titles = JSON.parse(body);
				titles.forEach(function (title) {
					const template = elementTemplate.cloneNode(true);
					template.insertAdjacentText("afterbegin", title);
					sidebarList.appendChild(template);
					template.addEventListener("click", () => loadPage(title));
				});
			}).catch(showError);
		});
	</script>
</head>

<body>
	<div class="main">
		<div class="sidebar">
			<div id="sidebarHeader" class="sidebarHeader">
				Differentia.js
				<br> Documentation
			</div>
			<div id="sidebarList" class="sidebarList"></div>
		</div>
		<div id="pageContainer" class="content container"></div>
		<div id="dimmer" class="dimmer"><div id="loadIndicator" class="loadIndicator"></div></div>
		<div id="errorContainer" class="error hidden"></div>
	</div>
</body>

</html>